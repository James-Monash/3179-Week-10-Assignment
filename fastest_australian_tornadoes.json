{
  "$schema": "https://vega.github.io/schema/vega-lite/v6.json",
  "width": 900,
  "height": 600,
  "projection": {"type": "mercator", "center": [134, -28], "scale": 850},
  "background": "#c6dbef",
  "title": {
    "text": "Top 5 Fastest Tornadoes by Wind Speed (Year range editable)",
    "anchor": "start",
    "fontSize": 18,
    "font": "Helvetica",
    "color": "#333"
  },
  "data": {
    "url": "https://raw.githubusercontent.com/James-Monash/3179-Week-10-Assignment/main/tornado_with_wind_speed_data.csv",
    "format": {
      "type": "csv",
      "parse": {
        "Date/Time": "date:%d/%m/%Y %H:%M"
      }
    }
  },
  "params": [
    {
      "name": "Min_Year",
      "value": 1900,
      "bind": {
        "input": "range",
        "min": 1900,
        "max": 2025,
        "step": 1,
        "name": "Start Year: "
      }
    },
    {
      "name": "Max_Year",
      "value": 2025,
      "bind": {
        "input": "range",
        "min": 1900,
        "max": 2025,
        "step": 1,
        "name": "End Year: "
      }
    }
  ],
  "transform": [
    {"calculate": "toNumber(datum['Max speed (km/h)'])", "as": "MaxSpeed"},
    {"calculate": "isValid(datum['Date/Time']) ? datum['Date/Time'] : null", "as": "ParsedDate"},
    {"filter": "datum.ParsedDate !== null"},
    {"calculate": "year(datum.ParsedDate)", "as": "Year"},
    {"calculate": "toNumber(datum.Longitude)", "as": "lon"},
    {"calculate": "toNumber(datum.Latitude)", "as": "lat"},
    {
      "filter": "isFinite(datum.MaxSpeed) && isFinite(datum.lon) && isFinite(datum.lat) && (datum.Year >= Min_Year) && (datum.Year <= Max_Year)"
    },
    {
      "window": [
        {"op": "row_number", "as": "rownum"}
      ],
      "sort": [
        {"field": "MaxSpeed", "order": "descending"},
        {"field": "ParsedDate", "order": "ascending"},
        {"field": "Tornado ID", "order": "ascending"}
      ]
    },
    {"filter": "datum.rownum <= 5"}
  ],
  "layer": [
    {
      "data": {
        "url": "https://raw.githubusercontent.com/James-Monash/3179-Week-10-Assignment/main/australia.json",
        "format": {"type": "topojson", "feature": "ne_50m_admin_1_states_provinces"}
      },
      "mark": {"type": "geoshape", "fill": "#f7f3ea", "stroke": "#999", "strokeWidth": 0.8}
    },
    {
      "data": {
        "url": "https://raw.githubusercontent.com/James-Monash/3179-Week-10-Assignment/main/10_degree_graticules_for_australia.json",
        "format": {"type": "topojson", "feature": "ne_50m_graticules_10"}
      },
      "mark": {"type": "geoshape", "stroke": "#ccc", "strokeWidth": 0.7}
    },
    {
      "mark": {"type": "image", "width": 36, "height": 36, "opacity": 1},
      "encoding": {
        "longitude": {"field": "lon", "type": "quantitative"},
        "latitude": {"field": "lat", "type": "quantitative"},
        "url": {
          "value": "https://raw.githubusercontent.com/James-Monash/3179-Week-10-Assignment/main/tornado.svg"
        },
        "tooltip": [
          {"field": "Date/Time", "type": "temporal", "title": "Date/Time"},
          {"field": "MaxSpeed", "type": "quantitative", "title": "Max wind speed"},
          {"field": "Tornado ID", "type": "nominal", "title": "Tornado ID"},
          {"field": "Year", "type": "ordinal", "title": "Year"}
        ]
      }
    },

    {
      "description": "Legend backdrop point (invisible) to anchor legend group location",
      "data": {"values": [{"lon": 153, "lat": -16}]},
      "mark": {"type": "point", "opacity": 0},
      "encoding": {
        "longitude": {"field": "lon", "type": "quantitative"},
        "latitude": {"field": "lat", "type": "quantitative"}
      }
    },

    {
      "description": "Legend items (text coloured by rating) positioned relative to anchor point",
      "data": {
        "values": [
          {"lon":153,"lat":-16,"label":"F0","color":"#999999","dy":-20,"dx":-60},
          {"lon":153,"lat":-16,"label":"F1","color":"#E69F00","dy":-8,"dx":-60},
          {"lon":153,"lat":-16,"label":"F2","color":"#56B4E9","dy":4,"dx":-60},
          {"lon":153,"lat":-16,"label":"F3","color":"#009E73","dy":16,"dx":-60},
          {"lon":153,"lat":-16,"label":"F4","color":"#F0E442","dy":28,"dx":-60},
          {"lon":153,"lat":-16,"label":"F5","color":"#984ea3","dy":40,"dx":-60}
        ]
      },
      "mark": {"type": "text", "fontSize": 12, "font": "Helvetica", "align": "left"},
      "encoding": {
        "longitude": {"field": "lon", "type": "quantitative"},
        "latitude": {"field": "lat", "type": "quantitative"},
        "text": {"field": "label", "type": "nominal"},
        "color": {"field": "color", "type": "nominal", "legend": null}
      },
      "transform": [
        {
          "calculate": "datum.dx",
          "as": "offx"
        },
        {
          "calculate": "datum.dy",
          "as": "offy"
        }
      ]
    },

    {
      "description": "Dynamic Start Year label (positioned above the Start slider)",
      "data": {"values":[{"lon":134,"lat":-9}]},
      "transform": [
        {"calculate": "Min_Year", "as": "minYear"}
      ],
      "mark": {"type": "text", "fontSize": 13, "font": "Helvetica", "align":"center", "dx":0, "dy":0, "color":"#222"},
      "encoding": {
        "longitude": {"field":"lon","type":"quantitative"},
        "latitude": {"field":"lat","type":"quantitative"},
        "text": {"expr":"'Start Year: ' + Min_Year"}
      }
    },

    {
      "description": "Dynamic End Year label (positioned above the End slider)",
      "data": {"values":[{"lon":134,"lat":-6}]},
      "transform": [
        {"calculate": "Max_Year", "as": "maxYear"}
      ],
      "mark": {"type": "text", "fontSize": 13, "font": "Helvetica", "align":"center", "dx":0, "dy":0, "color":"#222"},
      "encoding": {
        "longitude": {"field":"lon","type":"quantitative"},
        "latitude": {"field":"lat","type":"quantitative"},
        "text": {"expr":"'End Year: ' + Max_Year"}
      }
    }
  ],
  "config": {
    "legend": {"labelFont": "Helvetica", "titleFont": "Helvetica"},
    "title": {"font": "Helvetica"}
  }
}
